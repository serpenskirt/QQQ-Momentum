name: QQQ Momentum Strategy

on:
  schedule:
    # Runs every 5 minutes from hour 13 through 21 UTC (Approx 8am-5pm EST)
    # Mon-Fri (1-5)
    - cron: '*/5 13-21 * * 1-5'
  workflow_dispatch: # Allows manual trigger for testing

jobs:
  run-strategy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: pip install requests pandas pytz

      # ---------------------------------------------------------
      # STEP 1: SELL CHECK (PRIORITY - RUNS EVERY 5 MINS)
      # ---------------------------------------------------------
      - name: Run SELL Strategy
        env:
          TRADIER_TOKEN: ${{ secrets.TRADIER_TOKEN }}
          OA_WEBHOOK_SELL: ${{ secrets.OA_WEBHOOK_SELL }}
          OA_WEBHOOK_BUY: ${{ secrets.OA_WEBHOOK_BUY }}
        run: python main.py --mode sell

      # ---------------------------------------------------------
      # STEP 2: BUY CHECK (RUNS ONLY EVERY 10 MINS)
      # ---------------------------------------------------------
      - name: Run BUY Strategy
        env:
          TRADIER_TOKEN: ${{ secrets.TRADIER_TOKEN }}
          OA_WEBHOOK_BUY: ${{ secrets.OA_WEBHOOK_BUY }}
          OA_WEBHOOK_SELL: ${{ secrets.OA_WEBHOOK_SELL }}
        shell: bash
        run: |
          # Get the current minute
          MINUTE=$(date +'%M')
          
          # Check if minute ends in 0 (00, 10, 20...)
          if [[ "$MINUTE" =~ 0$ ]]; then
            echo "Current minute is $MINUTE. Running BUY logic."
            python main.py --mode buy
          else
            echo "Current minute is $MINUTE. Skipping BUY logic (10m Interval)."
          fi